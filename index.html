<script>
  let nombre1, nombre2;
  let score = 0;
  let bonnes = 0;
  let mauvaises = 0;
  let partieEnCours = false;
  let questionsMax = 10;
  let questionsJouees = 0;
  let modeGrandNombre = false;
  let defiActif = false;

  let tempsRestant = 10;
  let timerQuestionInterval = null;

  function toggleMode() {
    document.body.classList.toggle('dark');
  }

  function lancerPartie() {
    score = 0;
    bonnes = 0;
    mauvaises = 0;
    questionsJouees = 0;
    updateAffichageScore();
    document.getElementById('feedback').innerText = "";
    document.getElementById('resume').style.display = "none";
    document.getElementById('gif-felicitation').style.display = "none";
    document.getElementById('gif-felicitation').src = "";

    modeGrandNombre = document.getElementById('mode-grand-nombre').checked;
    defiActif = document.getElementById('defi-mode').checked;
    questionsMax = parseInt(document.getElementById('nombre-questions').value);
    if (isNaN(questionsMax) || questionsMax < 1) questionsMax = 10;

    partieEnCours = true;
    document.getElementById('user-answer').disabled = false;
    document.getElementById('btn-verifier').disabled = false;

    questionsJouees = 0;
    nouvelleQuestion();
  }

  function nouvelleQuestion() {
    if (!partieEnCours) return;

    if (questionsJouees >= questionsMax) {
      finDuJeu();
      return;
    }

    questionsJouees++;

    if (modeGrandNombre) {
      nombre1 = Math.floor(Math.random() * 10) + 1;
      nombre2 = Math.floor(Math.random() * 1000) + 1;
    } else {
      nombre1 = Math.floor(Math.random() * 10) + 1;
      nombre2 = Math.floor(Math.random() * 10) + 1;
    }

    document.getElementById('question').innerText = `Question ${questionsJouees} / ${questionsMax} : Combien font ${nombre1} × ${nombre2} ?`;
    document.getElementById('user-answer').value = "";
    document.getElementById('feedback').innerText = "";

    document.getElementById('user-answer').disabled = false;
    document.getElementById('btn-verifier').disabled = false;
    document.getElementById('user-answer').focus();

    // Gérer timer selon mode :
    if (defiActif) {
      // Si défi activé : 
      tempsRestant = modeGrandNombre ? 30 : 10; // 30 sec si mode grand nombre + défi, sinon 10 sec
      startTimer();
    } else {
      // Pas de timer si défi désactivé, même en mode grand nombre seul
      stopTimer();
      document.getElementById('chrono').innerText = "";
    }
  }

  function startTimer() {
    afficherTimer();
    if (timerQuestionInterval) clearInterval(timerQuestionInterval);
    timerQuestionInterval = setInterval(() => {
      tempsRestant--;
      afficherTimer();

      if (tempsRestant <= 0) {
        clearInterval(timerQuestionInterval);
        tempsEcoule();
      }
    }, 1000);
  }

  function stopTimer() {
    if (timerQuestionInterval) clearInterval(timerQuestionInterval);
  }

  function afficherTimer() {
    document.getElementById('chrono').innerText = `⏳ Temps restant : ${tempsRestant} sec`;
  }

  function tempsEcoule() {
    document.getElementById('btn-verifier').disabled = true;
    document.getElementById('user-answer').disabled = true;

    mauvaises++;
    updateAffichageScore();
    const bonneReponse = nombre1 * nombre2;
    document.getElementById('feedback').innerText = `⏰ Temps écoulé ! La réponse était ${bonneReponse}.`;

    setTimeout(() => {
      if (questionsJouees >= questionsMax) {
        finDuJeu();
      } else {
        nouvelleQuestion();
      }
    }, 5000);
  }

  function verifier() {
    if (!partieEnCours) return;

    stopTimer();

    const reponse = parseInt(document.getElementById('user-answer').value);
    const bonneReponse = nombre1 * nombre2;
    const feedback = document.getElementById('feedback');

    if (isNaN(reponse)) {
      feedback.innerText = "⛔ Entrez un nombre.";
      return;
    }

    if (reponse === bonneReponse) {
      feedback.innerText = "✅ Bonne réponse !";
      score++;
      bonnes++;
    } else {
      feedback.innerText = `❌ Mauvaise réponse. C'était ${bonneReponse}.`;
      mauvaises++;
    }

    updateAffichageScore();

    document.getElementById('btn-verifier').disabled = true;
    document.getElementById('user-answer').disabled = true;

    setTimeout(() => {
      if (questionsJouees >= questionsMax) {
        finDuJeu();
      } else {
        nouvelleQuestion();
      }
    }, 5000);
  }

  function updateAffichageScore() {
    document.getElementById('score').innerText = score;
    document.getElementById('bonnes').innerText = bonnes;
    document.getElementById('mauvaises').innerText = mauvaises;
  }

  function finDuJeu() {
    partieEnCours = false;
    stopTimer();
    document.getElementById('user-answer').disabled = true;
    document.getElementById('btn-verifier').disabled = true;
    document.getElementById('chrono').innerText = "";

    const total = bonnes + mauvaises;
    const pourcentage = total > 0 ? Math.round((score / total) * 100) : 0;

    const resumeDiv = document.getElementById('resume');
    resumeDiv.style.display = "block";
    resumeDiv.innerHTML = `
      🎉 Fin du jeu !<br/>
      Score final : ${score} / ${total} (${pourcentage}%)<br/>
      ✅ Bonnes réponses : ${bonnes}<br/>
      ❌ Erreurs : ${mauvaises}
    `;

    // Affiche un GIF selon le score
    const gif = document.getElementById('gif-felicitation');
    if (pourcentage > 80) {
      gif.src = "https://media.giphy.com/media/111ebonMs90YLu/giphy.gif"; // Bravo
    } else if (pourcentage > 50) {
      gif.src = "https://media.giphy.com/media/3o6ZsXh4kD6REY61eI/giphy.gif"; // Encouragement
    } else {
      gif.src = "https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif"; // Essaie encore
    }
    gif.style.display = "block";
  }
</script>
